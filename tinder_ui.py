import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext, filedialog
import threading
import os
import sys
from datetime import datetime
from dotenv import load_dotenv
from Api_Shodan import shodan_servisleri_al, nmap_ile_surumu_bul, nmap_ile_servisleri_bul, nmap_hizli_port_tarama, shodan_port_sorgula, shodan_genel_arama
from Main import mitre_cve_ara, llm_cozum_onerisi_getir, shodan_mitre_llm_analiz, shodan_ip_acik_portlari_goster
from output_capture import OutputCapture
import re

# PDF olu≈üturma i√ßin gerekli importlar
try:
    from reportlab.lib.pagesizes import A4
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, PageBreak
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.units import inch
    from reportlab.lib import colors
    from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_JUSTIFY
    from reportlab.pdfbase import pdfmetrics
    from reportlab.pdfbase.ttfonts import TTFont
    from reportlab.pdfbase.cidfonts import UnicodeCIDFont
    PDF_AVAILABLE = True
except ImportError:
    PDF_AVAILABLE = False

def sanitize_for_pdf(text: str) -> str:
	"""PDF i√ßin metni g√ºvenli hale getirir: emoji ve problemli Unicodelarƒ± temizler, T√ºrk√ße karakterleri ASCII'ye d√∂n√º≈üt√ºr√ºr."""
	if not isinstance(text, str):
		return text
	# T√ºrk√ße karakter d√∂n√º≈ü√ºm√º
	translations = str.maketrans({
		'√ß':'c','√á':'C','ƒü':'g','ƒû':'G','ƒ±':'i','ƒ∞':'I','√∂':'o','√ñ':'O','≈ü':'s','≈û':'S','√º':'u','√ú':'U'
	})
	clean = text.translate(translations)
	# Emoji ve BMP dƒ±≈üƒ± karakterleri kaldƒ±r
	clean = re.sub(r"[\U00010000-\U0010FFFF]", "", clean)
	# Kontrol edilemeyen diƒüer semboller yerine bo≈üluk
	clean = re.sub(r"[\u0000-\u001F]", " ", clean)
	return clean

class ModernUI:
    def __init__(self, root):
        self.root = root
        self.root.title(" Zafiyet Bulucu Pro")
        self.root.geometry("1200x800")
        self.root.configure(bg="#1a1a2e")
        
  
        self.output_capture = OutputCapture()
        
      
        self.current_analysis_result = ""
        self.found_services = []
        self.cve_results = {}
        self.open_ports = []
        self.llm_analysis_results = ""  # LLM sonu√ßlarƒ± i√ßin ayrƒ± deƒüi≈üken
        
     
        self.colors = {
            'bg_dark': '#1a1a2e',
            'bg_card': '#16213e',
            'bg_input': '#0f3460',
            'primary': '#e94560',
            'secondary': '#533483',
            'accent': '#00d4ff',
            'success': '#00ff88',
            'warning': '#ffaa00',
            'danger': '#ff4757',
            'text_light': '#ffffff',
            'text_gray': '#a0a0a0',
            'border': '#2d3748',
            'cve_highlight': '#ff6b6b',
            'llm_highlight': '#4ecdc4',
            'ai_highlight': '#45b7d1'
        }
        
        self.setup_ui()
        
    def setup_ui(self):
      
        main_frame = tk.Frame(self.root, bg=self.colors['bg_dark'])
        main_frame.pack(fill='both', expand=True, padx=30, pady=30)
        
       
        title_frame = tk.Frame(main_frame, bg=self.colors['bg_dark'])
        title_frame.pack(fill='x', pady=(0, 30))
        
        title_label = tk.Label(
            title_frame,
            text=" Zafiyet Bulucu Pro",
            font=("Segoe UI", 28, "bold"),
            fg=self.colors['primary'],
            bg=self.colors['bg_dark']
        )
        title_label.pack()
        
        subtitle_label = tk.Label(
            title_frame,
            text="G√ºvenlik Analizi & Zafiyet Tespiti",
            font=("Segoe UI", 14),
            fg=self.colors['text_gray'],
            bg=self.colors['bg_dark']
        )
        subtitle_label.pack(pady=(5, 0))
        
    
        self.card_frame = tk.Frame(main_frame, bg=self.colors['bg_dark'])
        self.card_frame.pack(fill='both', expand=True)
        
      
        self.show_main_menu_card()
        
    def create_rounded_button(self, parent, text, command, color='primary', size='normal'):
        """Modern yuvarlak k√∂≈üeli buton olu≈üturur"""
        btn = tk.Button(
            parent,
            text=text,
            font=("Segoe UI", 12 if size == 'normal' else 14, "bold"),
            bg=self.colors[color],
            fg=self.colors['text_light'],
            relief='flat',
            padx=25,
            pady=12,
            command=command,
            cursor='hand2'
        )
        btn.bind('<Enter>', lambda e, b=btn, c=color: self.on_button_hover(b, c, True))
        btn.bind('<Leave>', lambda e, b=btn, c=color: self.on_button_hover(b, c, False))
        return btn
        
    def on_button_hover(self, button, color, entering):
        if entering:
            button.configure(bg=self.colors['accent'])
        else:
            button.configure(bg=self.colors[color])
            
    def show_main_menu_card(self):
    
        for widget in self.card_frame.winfo_children():
            widget.destroy()
            
     
        card = tk.Frame(
            self.card_frame,
            bg=self.colors['bg_card'],
            relief='flat',
            bd=0
        )
        card.pack(fill='both', expand=True, padx=20, pady=20)
        
     
        card_title = tk.Label(
            card,
            text=" Analiz Se√ßenekleri",
            font=("Segoe UI", 22, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        card_title.pack(pady=(30, 40))
        
       
        button_frame = tk.Frame(card, bg=self.colors['bg_card'])
        button_frame.pack(fill='both', expand=True, padx=80, pady=40)
        
        # Butonlar (a√ßƒ±klama metinleri ile)
        button_info = [
            ("üîç IP Zafiyet Analizi", self.show_ip_analysis_card, 'primary', "Shodan, Nmap ve CVE analizi"),
            ("‚ö° Hƒ±zlƒ± Nmap Tarama", self.show_nmap_scan_card, 'secondary', "Port ve servis tespiti"),
            ("üì° A√ßƒ±k Port Taramasƒ±", self.show_port_list_card, 'accent', "Hedef IP a√ßƒ±k portlar"),
            ("üîé Shodan Arama", self.show_general_search_card, 'warning', "Genel arama ve ke≈üif")
        ]
        
        for i, (text, command, color, desc) in enumerate(button_info):
            row = i // 2
            col = i % 2
            tile = tk.Frame(button_frame, bg=self.colors['bg_card'])
            tile.grid(row=row, column=col, padx=20, pady=15, sticky='ew')
            btn = self.create_rounded_button(tile, text, command, color)
            btn.pack(fill='x')
            tk.Label(
                tile,
                text=desc,
                font=("Segoe UI", 10),
                fg=self.colors['text_gray'],
                bg=self.colors['bg_card']
            ).pack(pady=(6, 0))
        
        # S√ºtun esnekliƒüi
        button_frame.grid_columnconfigure(0, weight=1)
        button_frame.grid_columnconfigure(1, weight=1)
            
    def show_ip_analysis_card(self):
        """IP zafiyet analizi kartƒ±nƒ± g√∂ster"""
        for widget in self.card_frame.winfo_children():
            widget.destroy()
            
        # Ana kart
        card = tk.Frame(
            self.card_frame,
            bg=self.colors['bg_card'],
            relief='flat',
            bd=0
        )
        card.pack(fill='both', expand=True, padx=20, pady=20)
        
        # √úst bar
        top_bar = tk.Frame(card, bg=self.colors['bg_card'])
        top_bar.pack(fill='x', padx=20, pady=20)
        
        # Geri butonu
        back_btn = self.create_rounded_button(
            top_bar, "‚Üê Geri", self.show_main_menu_card, 'warning', 'small'
        )
        back_btn.pack(side='left')
        
        # Ba≈ülƒ±k
        title = tk.Label(
            top_bar,
            text=" IP Zafiyet Analizi",
            font=("Segoe UI", 20, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        title.pack(side='right')
        
        # Sol panel
        left_panel = tk.Frame(card, bg=self.colors['bg_card'])
        left_panel.pack(side='left', fill='y', padx=(40, 20), pady=30)
        
        # IP giri≈üi
        input_label = tk.Label(
            left_panel,
            text="IP Adresi:",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        input_label.pack(anchor='w', pady=(0, 10))
        
        # Input container
        input_container = tk.Frame(left_panel, bg=self.colors['bg_input'], relief='flat', bd=0)
        input_container.pack(fill='x', pady=(0, 20))
        
        self.ip_entry = tk.Entry(
            input_container,
            font=("Consolas", 14),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            relief='flat',
            bd=0,
            insertbackground=self.colors['text_light']
        )
        self.ip_entry.pack(fill='x', padx=15, pady=15)
        
        # Buton container
        button_container = tk.Frame(left_panel, bg=self.colors['bg_card'])
        button_container.pack(fill='x', pady=20)
        
        # Servisleri bul butonu (ana analiz butonu)
        analyze_btn = self.create_rounded_button(
            button_container, "üîç Servisleri Bul & CVE Analizi", self.find_services_and_cve, 'success'
        )
        analyze_btn.pack(fill='x', pady=(0, 10))
        
        # LLM analizi butonu
        llm_btn = self.create_rounded_button(
            button_container, "ü§ñ LLM √á√∂z√ºm √ñnerisi", self.show_llm_analysis_window, 'primary'
        )
        llm_btn.pack(fill='x', pady=(0, 10))
        
        # Sonucu kaydet butonu
        save_btn = self.create_rounded_button(
            button_container, "üíæ Sonucu Kaydet", self.save_analysis_result, 'accent'
        )
        save_btn.pack(fill='x')
        
        # Saƒü panel
        right_panel = tk.Frame(card, bg=self.colors['bg_card'])
        right_panel.pack(side='right', fill='both', expand=True, padx=(20, 40), pady=30)
        
        result_label = tk.Label(
            right_panel,
            text=" Analiz Sonu√ßlarƒ±:",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        result_label.pack(anchor='w', pady=(0, 10))
        
        # Sonu√ß text alanƒ±
        self.result_text = scrolledtext.ScrolledText(
            right_panel,
            height=25,
            font=("Consolas", 11),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            relief='flat',
            bd=0,
            insertbackground=self.colors['text_light'],
            selectbackground=self.colors['primary']
        )
        self.result_text.pack(fill='both', expand=True)
        
    def find_services_and_cve(self):
        """IP'deki servisleri bul ve CVE analizi yap"""
        ip = self.ip_entry.get().strip()
        if not ip:
            messagebox.showerror("Hata", "L√ºtfen bir IP adresi girin!")
            return
            
        def run_complete_analysis():
            self.result_text.delete(1.0, tk.END)
            self.result_text.insert(tk.END, f"üîç {ip} i√ßin kapsamlƒ± analiz ba≈ülatƒ±lƒ±yor...\n")
            self.result_text.insert(tk.END, "=" * 80 + "\n\n")
            self.root.update()
            
            # Analiz sonu√ßlarƒ±nƒ± temizle
            self.current_analysis_result = ""
            self.llm_analysis_results = ""
            
            try:
                # 1. Adƒ±m: Shodan'dan servisleri al
                self.result_text.insert(tk.END, "üì° Shodan'dan servis bilgileri alƒ±nƒ±yor...\n")
                self.found_services = shodan_servisleri_al(ip)
                
                if not self.found_services:
                    self.result_text.insert(tk.END, "‚ùå Bu IP'de Shodan'da servis kaydƒ± bulunamadƒ±.\n")
                    self.result_text.insert(tk.END, "üí° IP adresini kontrol edin veya farklƒ± bir IP deneyin.\n")
                    return
                
                self.result_text.insert(tk.END, f"‚úÖ {len(self.found_services)} servis bulundu!\n\n")
                
                # 2. Adƒ±m: Her servis i√ßin s√ºr√ºm kontrol√º ve CVE analizi
                total_cves = 0
                self.cve_results = {}
                all_cves = []
                analyzed_services = 0
                skipped_services = 0
                
                total_services = len(self.found_services)
                
                for i, service in enumerate(self.found_services, 1):
                    urun = service['urun']
                    surum = service['surum']
                    port = service['port']
                    
                    self.result_text.insert(tk.END, f"üîç [{i}/{total_services}] {urun} (Port: {port})\n")
                    self.root.update()
                    
                    # S√ºr√ºm kontrol√º
                    if not surum:
                        self.result_text.insert(tk.END, f"   üîß S√ºr√ºm tespit ediliyor (nmap)...\n")
                        urun, surum = nmap_ile_surumu_bul(ip, port)
                    
                    if not urun or not surum:
                        self.result_text.insert(tk.END, f"   ‚ö†Ô∏è S√ºr√ºm tespit edilemedi - CVE analizi atlanƒ±yor.\n\n")
                        skipped_services += 1
                        continue
                    
                    self.result_text.insert(tk.END, f"   üìã S√ºr√ºm: {surum}\n")
                    analyzed_services += 1
                    
                    # CVE analizi
                    self.result_text.insert(tk.END, f"   üîç CVE kayƒ±tlarƒ± aranƒ±yor...\n")
                    cve_listesi = mitre_cve_ara(urun, surum)
                    
                    if cve_listesi:
                        self.result_text.insert(tk.END, f"   ‚úÖ {len(cve_listesi)} CVE bulundu!\n")
                        total_cves += len(cve_listesi)
                        self.cve_results[f"{urun}_{surum}"] = cve_listesi
                        
                        # CVE'leri listeye ekle
                        for cve in cve_listesi:
                            all_cves.append({
                                'cve': cve,
                                'service': f"{urun} {surum}",
                                'port': port
                            })
                        
                        # ƒ∞lk 3 CVE'yi g√∂ster
                        for j, cve in enumerate(cve_listesi[:3], 1):
                            self.result_text.insert(tk.END, f"      {j}. {cve['cve_id']}: {cve['aciklama'][:80]}...\n")
                        
                        if len(cve_listesi) > 3:
                            self.result_text.insert(tk.END, f"      ... ve {len(cve_listesi) - 3} CVE daha\n")
                    else:
                        self.result_text.insert(tk.END, f"   ‚ùå CVE kaydƒ± bulunamadƒ±.\n")
                    
                    self.result_text.insert(tk.END, "\n")
                    
                    # Kƒ±sa bekleme
                    if i < total_services:
                        self.root.update()
                        import time
                        time.sleep(0.2)
                
                self.result_text.insert(tk.END, f"üéØ Analiz tamamlandƒ±!\n")
                self.result_text.insert(tk.END, f"üìä √ñzet:\n")
                self.result_text.insert(tk.END, f"   ‚Ä¢ Toplam Servis: {len(self.found_services)}\n")
                self.result_text.insert(tk.END, f"   ‚Ä¢ Analiz Edilen: {analyzed_services}\n")
                self.result_text.insert(tk.END, f"   ‚Ä¢ Atlanan (S√ºr√ºm Yok): {skipped_services}\n")
                self.result_text.insert(tk.END, f"   ‚Ä¢ Bulunan CVE: {total_cves}\n\n")
                
                # CVE analiz sonu√ßlarƒ±nƒ± sakla
                self.current_analysis_result = f"üîç IP Adresi: {ip}\n"
                self.current_analysis_result += f"üì° Toplam Servis Sayƒ±sƒ±: {len(self.found_services)}\n"
                self.current_analysis_result += f"üîß Analiz Edilen Servis: {analyzed_services}\n"
                self.current_analysis_result += f"‚ö†Ô∏è Atlanan Servis (S√ºr√ºm Yok): {skipped_services}\n"
                self.current_analysis_result += f"üéØ Bulunan CVE Sayƒ±sƒ±: {total_cves}\n"
                self.current_analysis_result += "=" * 60 + "\n\n"
                
                if self.cve_results:
                    for service_key, cve_list in self.cve_results.items():
                        self.current_analysis_result += f"üìã Servis: {service_key.replace('_', ' ')}\n"
                        for cve in cve_list:
                            self.current_analysis_result += f"  üîç {cve['cve_id']}: {cve['aciklama']}\n"
                        self.current_analysis_result += "\n"
                else:
                    self.current_analysis_result += "‚ùå Analiz edilebilir servis bulunamadƒ± (s√ºr√ºm bilgisi gerekli).\n\n"
                
                if all_cves:
                    self.result_text.insert(tk.END, "ü§ñ LLM √ß√∂z√ºm √∂nerileri i√ßin 'LLM √á√∂z√ºm √ñnerisi' butonuna tƒ±klayƒ±n.\n")
                    self.result_text.insert(tk.END, "=" * 80 + "\n\n")
                    self.root.update()
                    
                    # CVE se√ßim aray√ºz√ºn√º olu≈ütur
                    self.create_cve_selection_interface(all_cves)
                else:
                    self.result_text.insert(tk.END, "‚ö†Ô∏è LLM analizi i√ßin CVE bulunamadƒ±.\n")
                
            except Exception as e:
                self.result_text.insert(tk.END, f"\n‚ùå Hata: {str(e)}\n")
                
        threading.Thread(target=run_complete_analysis, daemon=True).start()
        
    def show_llm_analysis_window(self):
        """LLM √ß√∂z√ºm √∂nerisi i√ßin ayrƒ± pencere a√ß"""
        if not hasattr(self, 'cve_results') or not self.cve_results:
            messagebox.showwarning("‚ö†Ô∏è Uyarƒ±", "LLM analizi i√ßin CVE bulunamadƒ±!\n\n√ñnce 'üîç Servisleri Bul & CVE Analizi' butonuna tƒ±klayarak analiz yapƒ±n.\n\nNot: Sadece s√ºr√ºm bilgisi olan servisler i√ßin CVE analizi yapƒ±lƒ±r.")
            return
            
        # Yeni pencere olu≈ütur
        llm_window = tk.Toplevel(self.root)
        llm_window.title("ü§ñ LLM √á√∂z√ºm √ñnerisi")
        llm_window.geometry("1000x700")
        llm_window.configure(bg=self.colors['bg_dark'])
        llm_window.resizable(True, True)
        
        # Pencereyi ortala
        self.center_window(llm_window)
        
        # Ana frame
        main_frame = tk.Frame(llm_window, bg=self.colors['bg_dark'])
        main_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Ba≈ülƒ±k
        title_label = tk.Label(
            main_frame,
            text="ü§ñ LLM √á√∂z√ºm √ñnerisi",
            font=("Segoe UI", 18, "bold"),
            fg=self.colors['primary'],
            bg=self.colors['bg_dark']
        )
        title_label.pack(pady=(0, 20))
        
        # CVE listesi frame
        list_frame = tk.Frame(main_frame, bg=self.colors['bg_card'])
        list_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # CVE listesi ba≈ülƒ±ƒüƒ±
        list_title = tk.Label(
            list_frame,
            text="üìã Bulunan CVE'ler:",
            font=("Segoe UI", 12, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        list_title.pack(anchor='w', padx=15, pady=(15, 10))
        
        # CVE listesi (Treeview)
        tree_frame = tk.Frame(list_frame, bg=self.colors['bg_card'])
        tree_frame.pack(fill='both', expand=True, padx=15, pady=(0, 15))
        
        # Scrollbar
        scrollbar = ttk.Scrollbar(tree_frame)
        scrollbar.pack(side='right', fill='y')
        
        # Treeview
        self.llm_cve_tree = ttk.Treeview(
            tree_frame,
            columns=('cve_id', 'service', 'port', 'description'),
            show='headings',
            yscrollcommand=scrollbar.set,
            selectmode='extended',
            style='Custom.Treeview'
        )
        scrollbar.config(command=self.llm_cve_tree.yview)
        
        # S√ºtun ba≈ülƒ±klarƒ±
        self.llm_cve_tree.heading('cve_id', text='CVE ID', anchor='w')
        self.llm_cve_tree.heading('service', text='Servis', anchor='w')
        self.llm_cve_tree.heading('port', text='Port', anchor='w')
        self.llm_cve_tree.heading('description', text='A√ßƒ±klama', anchor='w')
        
        # S√ºtun geni≈ülikleri
        self.llm_cve_tree.column('cve_id', width=120, anchor='w')
        self.llm_cve_tree.column('service', width=150, anchor='w')
        self.llm_cve_tree.column('port', width=60, anchor='center')
        self.llm_cve_tree.column('description', width=400, anchor='w')
        
        self.llm_cve_tree.pack(fill='both', expand=True)
        
        # Treeview stilini ayarla
        style = ttk.Style()
        style.theme_use('clam')
        style.configure('Custom.Treeview', 
                      background=self.colors['bg_input'],
                      foreground=self.colors['text_light'],
                      fieldbackground=self.colors['bg_input'],
                      borderwidth=0)
        style.configure('Custom.Treeview.Heading', 
                      background=self.colors['secondary'],
                      foreground=self.colors['text_light'],
                      relief='flat',
                      font=('Segoe UI', 10, 'bold'))
        style.map('Custom.Treeview', 
                 background=[('selected', self.colors['primary'])],
                 foreground=[('selected', 'white')])
        
        # CVE'leri listeye ekle
        all_cves = []
        for service_key, cve_list in self.cve_results.items():
            for cve in cve_list:
                all_cves.append({
                    'cve': cve,
                    'service': service_key.replace('_', ' '),
                    'port': 'N/A'  # Port bilgisi servis anahtarƒ±nda yok
                })
        
        self.llm_cve_vars = {}
        for i, cve_data in enumerate(all_cves):
            cve = cve_data['cve']
            service = cve_data['service']
            port = cve_data['port']
            
            # Kƒ±sa a√ßƒ±klama
            short_desc = (cve['aciklama'][:97] + '...') if len(cve['aciklama']) > 100 else cve['aciklama']
            
            # Treeview'a ekle
            item_id = self.llm_cve_tree.insert('', 'end', 
                                             values=(cve['cve_id'], service, port, short_desc),
                                             tags=('clickable',))
            
            # CVE verilerini sakla
            self.llm_cve_vars[item_id] = {
                'cve': cve,
                'selected': False
            }
        
        # √áift tƒ±klama olayƒ±
        self.llm_cve_tree.tag_bind('clickable', '<Double-1>', self.on_llm_cve_double_click)
        
        # Buton frame
        button_frame = tk.Frame(main_frame, bg=self.colors['bg_dark'])
        button_frame.pack(fill='x', pady=(20, 0))
        
        # Butonlar
        select_all_btn = tk.Button(
            button_frame,
            text="‚úì T√ºm√ºn√º Se√ß",
            font=("Segoe UI", 10, "bold"),
            bg=self.colors['success'],
            fg='white',
            relief='flat',
            padx=15,
            pady=8,
            command=self.select_all_llm_cves
        )
        select_all_btn.pack(side='left', padx=5)
        
        deselect_all_btn = tk.Button(
            button_frame,
            text="‚úó Se√ßimi Kaldƒ±r",
            font=("Segoe UI", 10, "bold"),
            bg=self.colors['danger'],
            fg='white',
            relief='flat',
            padx=15,
            pady=8,
            command=self.deselect_all_llm_cves
        )
        deselect_all_btn.pack(side='left', padx=5)
        
        analyze_btn = tk.Button(
            button_frame,
            text="ü§ñ Se√ßilenler i√ßin LLM Analizi",
            font=("Segoe UI", 12, "bold"),
            bg=self.colors['primary'],
            fg='white',
            relief='flat',
            padx=20,
            pady=10,
            command=lambda: self.analyze_selected_llm_cves(llm_window)
        )
        analyze_btn.pack(side='right', padx=5)
        
    def on_llm_cve_double_click(self, event):
        """LLM penceresinde CVE'ye √ßift tƒ±klandƒ±ƒüƒ±nda"""
        item = self.llm_cve_tree.selection()[0]
        cve_data = self.llm_cve_vars[item]['cve']
        
        # Detay penceresi
        detail_window = tk.Toplevel(self.root)
        detail_window.title(f"CVE Detay: {cve_data['cve_id']}")
        detail_window.geometry("600x400")
        detail_window.configure(bg=self.colors['bg_dark'])
        detail_window.resizable(True, True)
        
        # Ba≈ülƒ±k
        title_frame = tk.Frame(detail_window, bg=self.colors['bg_dark'])
        title_frame.pack(fill='x', padx=20, pady=10)
        
        title_label = tk.Label(
            title_frame,
            text=f"üìã {cve_data['cve_id']} Detaylarƒ±",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['primary'],
            bg=self.colors['bg_dark']
        )
        title_label.pack(side='left')
        
        # ƒ∞√ßerik
        content_frame = tk.Frame(detail_window, bg=self.colors['bg_card'])
        content_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # Detay text
        detail_text = scrolledtext.ScrolledText(
            content_frame,
            wrap=tk.WORD,
            font=("Consolas", 10),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            padx=10,
            pady=10
        )
        detail_text.pack(fill='both', expand=True)
        
        # CVE bilgilerini ekle
        detail_text.insert(tk.END, f"üîç CVE ID: {cve_data['cve_id']}\n\n")
        detail_text.insert(tk.END, f"üìù A√ßƒ±klama:\n{cve_data['aciklama']}\n\n")
        
        # Pencereyi ortala
        self.center_window(detail_window)
        
    def select_all_llm_cves(self):
        """LLM penceresinde t√ºm CVE'leri se√ß"""
        for item in self.llm_cve_tree.get_children():
            self.llm_cve_tree.selection_add(item)
            self.llm_cve_vars[item]['selected'] = True
    
    def deselect_all_llm_cves(self):
        """LLM penceresinde t√ºm CVE se√ßimlerini kaldƒ±r"""
        self.llm_cve_tree.selection_remove(self.llm_cve_tree.get_children())
        for item in self.llm_cve_vars:
            self.llm_cve_vars[item]['selected'] = False
    
    def analyze_selected_llm_cves(self, llm_window):
        """LLM penceresinde se√ßilen CVE'ler i√ßin analiz yap"""
        selected_items = self.llm_cve_tree.selection()
        
        if not selected_items:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen en az bir CVE se√ßin!")
            return
        
        selected_cves = []
        for item in selected_items:
            selected_cves.append(self.llm_cve_vars[item]['cve'])
            self.llm_cve_vars[item]['selected'] = True
        
        # LLM analizi i√ßin yeni pencere a√ß
        self.show_llm_analysis_results(selected_cves, llm_window)
        
    def show_llm_analysis_results(self, selected_cves, parent_window):
        """LLM analiz sonu√ßlarƒ±nƒ± g√∂ster"""
        # Sonu√ß penceresi
        result_window = tk.Toplevel(parent_window)
        result_window.title("ü§ñ LLM Analiz Sonu√ßlarƒ±")
        result_window.geometry("1200x800")
        result_window.configure(bg=self.colors['bg_dark'])
        result_window.resizable(True, True)
        
        # Pencereyi ortala
        self.center_window(result_window)
        
        # Ana frame
        main_frame = tk.Frame(result_window, bg=self.colors['bg_dark'])
        main_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # Ba≈ülƒ±k
        title_label = tk.Label(
            main_frame,
            text=f"ü§ñ LLM Analiz Sonu√ßlarƒ± ({len(selected_cves)} CVE)",
            font=("Segoe UI", 16, "bold"),
            fg=self.colors['primary'],
            bg=self.colors['bg_dark']
        )
        title_label.pack(pady=(0, 20))
        
        # Sonu√ß text alanƒ±
        result_text = scrolledtext.ScrolledText(
            main_frame,
            wrap=tk.WORD,
            font=("Consolas", 11),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            padx=15,
            pady=15
        )
        result_text.pack(fill='both', expand=True)
        
        # Kaydet butonu frame
        save_frame = tk.Frame(main_frame, bg=self.colors['bg_dark'])
        save_frame.pack(fill='x', pady=(20, 0))
        
        # Kaydet butonu
        save_btn = tk.Button(
            save_frame,
            text="üíæ Bu Sonu√ßlarƒ± Kaydet",
            font=("Segoe UI", 12, "bold"),
            bg=self.colors['success'],
            fg='white',
            relief='flat',
            padx=20,
            pady=10,
            command=lambda: self.save_llm_results_to_file(result_text.get(1.0, tk.END), selected_cves)
        )
        save_btn.pack(side='right', padx=5)
        
        # Analiz ba≈ülat
        def run_llm_analysis():
            result_text.insert(tk.END, f"ü§ñ {len(selected_cves)} CVE i√ßin LLM analizi ba≈ülatƒ±lƒ±yor...\n")
            result_text.insert(tk.END, "=" * 80 + "\n\n")
            result_window.update()
            
            # LLM sonu√ßlarƒ±nƒ± saklamak i√ßin ge√ßici deƒüi≈üken
            llm_results = ""
            
            try:
                for i, cve in enumerate(selected_cves, 1):
                    result_text.insert(tk.END, f"üìã [{i}/{len(selected_cves)}] {cve['cve_id']} analiz ediliyor...\n")
                    result_window.update()
                    
                    try:
                        # LLM √ß√∂z√ºm √∂nerisi al
                        llm_solution = llm_cozum_onerisi_getir(cve['aciklama'])
                        
                        result_text.insert(tk.END, f"\nüîç CVE ID: {cve['cve_id']}\n")
                        result_text.insert(tk.END, f"üìù A√ßƒ±klama: {cve['aciklama']}\n")
                        result_text.insert(tk.END, "=" * 60 + "\n")
                        result_text.insert(tk.END, f"ü§ñ LLM √á√∂z√ºm √ñnerisi:\n{llm_solution}\n")
                        result_text.insert(tk.END, "=" * 60 + "\n\n")
                        
                        # Sonucu ge√ßici deƒüi≈ükende sakla
                        llm_results += f"\nüîç CVE ID: {cve['cve_id']}\n"
                        llm_results += f"üìù A√ßƒ±klama: {cve['aciklama']}\n"
                        llm_results += f"ü§ñ LLM √á√∂z√ºm √ñnerisi:\n{llm_solution}\n"
                        llm_results += "=" * 60 + "\n\n"
                        
                    except Exception as e:
                        result_text.insert(tk.END, f"‚ùå {cve['cve_id']} i√ßin LLM analizi hatasƒ±: {str(e)}\n\n")
                        continue
                    
                    # Her 2 CVE'de bir kƒ±sa bekleme
                    if i % 2 == 0:
                        result_text.insert(tk.END, "‚è≥ Kƒ±sa bir bekleme...\n")
                        result_window.update()
                        import time
                        time.sleep(0.5)
                
                result_text.insert(tk.END, f"‚úÖ Se√ßilen CVE'ler i√ßin LLM analizi tamamlandƒ±!\n")
                result_text.insert(tk.END, f"üíæ Sonu√ßlarƒ± kaydetmek i√ßin 'Bu Sonu√ßlarƒ± Kaydet' butonuna tƒ±klayƒ±n.\n")
                
                # LLM sonu√ßlarƒ±nƒ± ana pencereye aktar
                self.current_analysis_result = llm_results
                
            except Exception as e:
                result_text.insert(tk.END, f"\n‚ùå LLM analizi genel hatasƒ±: {str(e)}\n")
        
        threading.Thread(target=run_llm_analysis, daemon=True).start()
        
    def create_cve_selection_interface(self, all_cves):
        """Modern CVE se√ßim aray√ºz√º - Geni≈ületilebilir"""
        # Mevcut widget'larƒ± temizle
        for widget in self.result_text.master.winfo_children():
            if isinstance(widget, tk.Frame) and widget != self.result_text.master.winfo_children()[0]:
                widget.destroy()
        
        # Se√ßim frame'i - daha b√ºy√ºk ve geni≈ületilebilir
        selection_frame = tk.Frame(
            self.result_text.master, 
            bg=self.colors['bg_card'],
            relief='flat',
            bd=0,
            padx=15,
            pady=15
        )
        selection_frame.pack(side='bottom', fill='both', expand=True, padx=20, pady=(10, 10))
        
        # Header frame
        header_frame = tk.Frame(selection_frame, bg=self.colors['bg_card'])
        header_frame.pack(fill='x', pady=(0, 15))
        
        # Ba≈ülƒ±k
        title = tk.Label(
            header_frame,
            text="üìã CVE Se√ßimi - LLM √á√∂z√ºm √ñnerisi i√ßin CVE'leri Se√ßin:",
            font=("Segoe UI", 13, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        title.pack(side='left')
        
        # Buton frame
        button_frame = tk.Frame(header_frame, bg=self.colors['bg_card'])
        button_frame.pack(side='right')
        
        # T√ºm√ºn√º se√ß butonu
        select_all_btn = tk.Button(
            button_frame,
            text="‚úì T√ºm√ºn√º Se√ß",
            font=("Segoe UI", 10, "bold"),
            bg=self.colors['success'],
            fg='white',
            relief='flat',
            padx=12,
            pady=5,
            command=self.select_all_cves
        )
        select_all_btn.pack(side='left', padx=5)
        
        # Se√ßimi kaldƒ±r butonu
        deselect_all_btn = tk.Button(
            button_frame,
            text="‚úó Se√ßimi Kaldƒ±r",
            font=("Segoe UI", 10, "bold"),
            bg=self.colors['danger'],
            fg='white',
            relief='flat',
            padx=12,
            pady=5,
            command=self.deselect_all_cves
        )
        deselect_all_btn.pack(side='left', padx=5)
        
        # ƒ∞statistik etiketi
        self.cve_stats_label = tk.Label(
            button_frame,
            text=f"Toplam: {len(all_cves)} CVE",
            font=("Segoe UI", 10),
            fg=self.colors['text_gray'],
            bg=self.colors['bg_card']
        )
        self.cve_stats_label.pack(side='left', padx=15)
        
        # ƒ∞√ßerik frame - geni≈ületilebilir
        content_frame = tk.Frame(selection_frame, bg=self.colors['bg_card'])
        content_frame.pack(fill='both', expand=True)
        
        # Tree container
        tree_container = tk.Frame(content_frame, bg=self.colors['bg_card'])
        tree_container.pack(fill='both', expand=True)
        
        # Scrollbar
        scrollbar = ttk.Scrollbar(tree_container)
        scrollbar.pack(side='right', fill='y')
        
        # Treeview - daha b√ºy√ºk
        self.cve_tree = ttk.Treeview(
            tree_container,
            columns=('cve_id', 'service', 'port', 'description', 'severity'),
            show='headings',
            yscrollcommand=scrollbar.set,
            selectmode='extended',
            style='Custom.Treeview',
            height=8  # Daha y√ºksek
        )
        scrollbar.config(command=self.cve_tree.yview)
        
        # S√ºtun ba≈ülƒ±klarƒ±
        self.cve_tree.heading('cve_id', text='CVE ID', anchor='w')
        self.cve_tree.heading('service', text='Servis', anchor='w')
        self.cve_tree.heading('port', text='Port', anchor='w')
        self.cve_tree.heading('description', text='A√ßƒ±klama', anchor='w')
        self.cve_tree.heading('severity', text='√ñnem', anchor='center')
        
        # S√ºtun geni≈ülikleri - daha geni≈ü
        self.cve_tree.column('cve_id', width=130, anchor='w')
        self.cve_tree.column('service', width=180, anchor='w')
        self.cve_tree.column('port', width=70, anchor='center')
        self.cve_tree.column('description', width=450, anchor='w')
        self.cve_tree.column('severity', width=80, anchor='center')
        
        self.cve_tree.pack(fill='both', expand=True)
        
        # Treeview stili
        style = ttk.Style()
        style.theme_use('clam')
        style.configure('Custom.Treeview', 
                      background=self.colors['bg_input'],
                      foreground=self.colors['text_light'],
                      fieldbackground=self.colors['bg_input'],
                      borderwidth=0,
                      rowheight=25)  # Daha y√ºksek satƒ±rlar
        style.configure('Custom.Treeview.Heading', 
                      background=self.colors['secondary'],
                      foreground=self.colors['text_light'],
                      relief='flat',
                      font=('Segoe UI', 11, 'bold'))
        style.map('Custom.Treeview', 
                 background=[('selected', self.colors['primary'])],
                 foreground=[('selected', 'white')])
        
        # CVE'leri listeye ekle
        self.cve_vars = {} 
        for i, cve_data in enumerate(all_cves):
            cve = cve_data['cve']
            service = cve_data['service']
            port = cve_data['port']
            
            # Kƒ±sa a√ßƒ±klama
            short_desc = (cve['aciklama'][:97] + '...') if len(cve['aciklama']) > 100 else cve['aciklama']
            
            # √ñnem seviyesi (basit hesaplama)
            severity = "Y√ºksek" if any(keyword in cve['aciklama'].lower() for keyword in ['critical', 'high', 'severe', 'remote', 'execute']) else "Orta"
            
            # Treeview'a ekle
            item_id = self.cve_tree.insert('', 'end', 
                                         values=(cve['cve_id'], service, port, short_desc, severity),
                                         tags=('clickable',))
            
            # CVE verilerini sakla
            self.cve_vars[item_id] = {
                'cve': cve,
                'selected': False
            }
        
        # √áift tƒ±klama olayƒ±
        self.cve_tree.tag_bind('clickable', '<Double-1>', self.on_cve_double_click)
        
        # Alt frame
        bottom_frame = tk.Frame(content_frame, bg=self.colors['bg_card'])
        bottom_frame.pack(fill='x', pady=(15, 0))
        
        # Analiz butonu
        analyze_btn = self.create_rounded_button(
            bottom_frame, 
            "ü§ñ Se√ßilenler i√ßin LLM Analizi Ba≈ülat", 
            self.analyze_selected_cves, 
            'primary'
        )
        analyze_btn.pack(fill='x')
        
        # Se√ßim sayƒ±sƒ±nƒ± g√ºncelle
        self.update_cve_selection_count()
        
        # Se√ßim deƒüi≈üikliƒüi olayƒ±nƒ± baƒüla
        self.cve_tree.bind('<<TreeviewSelect>>', self.on_cve_selection_change)
    
    def update_cve_selection_count(self):
        """CVE se√ßim sayƒ±sƒ±nƒ± g√ºncelle"""
        if hasattr(self, 'cve_stats_label'):
            selected_count = len(self.cve_tree.selection())
            total_count = len(self.cve_tree.get_children())
            self.cve_stats_label.config(text=f"Se√ßili: {selected_count}/{total_count} CVE")
    
    def on_cve_selection_change(self, event):
        """CVE se√ßimi deƒüi≈ütiƒüinde √ßaƒürƒ±lƒ±r"""
        self.update_cve_selection_count()
    
    def on_cve_double_click(self, event):
        """Treeview'da bir CVE'ye √ßift tƒ±klandƒ±ƒüƒ±nda"""
        item = self.cve_tree.selection()[0]
        cve_data = self.cve_vars[item]['cve']
        
      
        detail_window = tk.Toplevel(self.root)
        detail_window.title(f"CVE Detay: {cve_data['cve_id']}")
        detail_window.geometry("600x400")
        detail_window.configure(bg=self.colors['bg_dark'])
        detail_window.resizable(True, True)
        
    
        title_frame = tk.Frame(detail_window, bg=self.colors['bg_dark'])
        title_frame.pack(fill='x', padx=20, pady=10)
        
        title_label = tk.Label(
            title_frame,
            text=f" {cve_data['cve_id']} Detaylarƒ±",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['primary'],
            bg=self.colors['bg_dark']
        )
        title_label.pack(side='left')
        
      
        content_frame = tk.Frame(detail_window, bg=self.colors['bg_card'])
        content_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
   
        detail_text = scrolledtext.ScrolledText(
            content_frame,
            wrap=tk.WORD,
            font=("Consolas", 10),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            padx=10,
            pady=10
        )
        detail_text.pack(fill='both', expand=True)
        
      
        detail_text.insert(tk.END, f" CVE ID: {cve_data['cve_id']}\n\n")
        detail_text.insert(tk.END, f" A√ßƒ±klama:\n{cve_data['aciklama']}\n\n")
        
        
        self.center_window(detail_window)
    
    def center_window(self, window):
        """Pencereyi ekranƒ±n ortasƒ±na yerle≈ütir"""
        window.update_idletasks()
        width = window.winfo_width()
        height = window.winfo_height()
        x = (window.winfo_screenwidth() // 2) - (width // 2)
        y = (window.winfo_screenheight() // 2) - (height // 2)
        window.geometry(f'{width}x{height}+{x}+{y}')
    
    def select_all_cves(self):
        """T√ºm CVE'leri se√ß"""
        for item in self.cve_tree.get_children():
            self.cve_tree.selection_add(item)
            self.cve_vars[item]['selected'] = True
        self.update_cve_selection_count()
    
    def deselect_all_cves(self):
        """T√ºm CVE se√ßimlerini kaldƒ±r"""
        self.cve_tree.selection_remove(self.cve_tree.get_children())
        for item in self.cve_vars:
            self.cve_vars[item]['selected'] = False
        self.update_cve_selection_count()
    
    def analyze_selected_cves(self):
        """Se√ßilen CVE'ler i√ßin LLM analizi yap"""
        selected_items = self.cve_tree.selection()
        
        if not selected_items:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen en az bir CVE se√ßin!")
            return
        
        selected_cves = []
        for item in selected_items:
            selected_cves.append(self.cve_vars[item]['cve'])
            self.cve_vars[item]['selected'] = True
        
        
        self.get_selected_llm_solutions(selected_cves)
    
    def get_selected_llm_solutions(self, selected_cves):
        """Se√ßilen CVE'ler i√ßin LLM √ß√∂z√ºm √∂nerilerini al"""
        def run_llm_analysis():
            self.result_text.insert(tk.END, f"\n {len(selected_cves)} se√ßilen CVE i√ßin LLM analizi ba≈ülatƒ±lƒ±yor...\n")
            self.result_text.insert(tk.END, "=" * 80 + "\n\n")
            self.root.update()
            
            try:
                for i, cve in enumerate(selected_cves, 1):
                    self.result_text.insert(tk.END, f" {i}/{len(selected_cves)} - {cve['cve_id']} analiz ediliyor...\n")
                    self.root.update()
                    
                    try:
                        # LLM √ß√∂z√ºm √∂nerisi al
                        llm_solution = llm_cozum_onerisi_getir(cve['aciklama'])
                        
                        self.result_text.insert(tk.END, f"\n CVE ID: {cve['cve_id']}\n")
                        self.result_text.insert(tk.END, f" A√ßƒ±klama: {cve['aciklama']}\n")
                        self.result_text.insert(tk.END, "=" * 50 + "\n")
                        self.result_text.insert(tk.END, f" LLM √á√∂z√ºm √ñnerisi:\n{llm_solution}\n")
                        self.result_text.insert(tk.END, "=" * 50 + "\n\n")
                        
                        # Sonucu sakla
                        self.current_analysis_result += f"\n CVE ID: {cve['cve_id']}\n"
                        self.current_analysis_result += f" A√ßƒ±klama: {cve['aciklama']}\n"
                        self.current_analysis_result += f" LLM √á√∂z√ºm √ñnerisi:\n{llm_solution}\n"
                        self.current_analysis_result += "=" * 50 + "\n\n"
                        
                    except Exception as e:
                        self.result_text.insert(tk.END, f" {cve['cve_id']} i√ßin LLM analizi hatasƒ±: {str(e)}\n\n")
                        continue
                    
                    # Her 2 CVE'de bir kƒ±sa bekleme (rate limiting i√ßin)
                    if i % 2 == 0:
                        self.result_text.insert(tk.END, " Kƒ±sa bir bekleme...\n")
                        self.root.update()
                        import time
                        time.sleep(0.5)  # 0.5 saniye bekleme
                
                self.result_text.insert(tk.END, f" Se√ßilen CVE'ler i√ßin LLM analizi tamamlandƒ±!\n")
                self.result_text.insert(tk.END, f" Sonu√ßlarƒ± kaydetmek i√ßin 'Sonucu Kaydet' butonuna tƒ±klayƒ±n.\n")
                
            except Exception as e:
                self.result_text.insert(tk.END, f"\n LLM analizi genel hatasƒ±: {str(e)}\n")
        
        threading.Thread(target=run_llm_analysis, daemon=True).start()
    
    def save_llm_results_to_file(self, llm_text_content, selected_cves):
        """LLM sonu√ßlarƒ±nƒ± dosyaya kaydet"""
        # Dosya formatƒ± se√ßimi
        file_types = [
            ("PDF Dosyasƒ±", "*.pdf"),
            ("Metin Dosyasƒ±", "*.txt"),
            ("T√ºm Dosyalar", "*.*")
        ]
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        default_filename = f"llm_analiz_sonuclari_{timestamp}"
        
        file_path = filedialog.asksaveasfilename(
            title="LLM Analiz Sonu√ßlarƒ±nƒ± Kaydet",
            defaultextension=".pdf",
            filetypes=file_types,
            initialfile=default_filename
        )
        
        if file_path:
            try:
                file_extension = os.path.splitext(file_path)[1].lower()
                
                if file_extension == '.pdf' and PDF_AVAILABLE:
                    self.create_llm_pdf_report(file_path, llm_text_content, selected_cves)
                    messagebox.showinfo("‚úÖ Ba≈üarƒ±lƒ±", f"LLM analiz sonu√ßlarƒ± PDF olarak kaydedildi:\n{file_path}")
                else:
                    # TXT dosyasƒ± olarak kaydet
                    if file_extension != '.txt':
                        file_path = file_path + '.txt'
                    
                    with open(file_path, 'w', encoding='utf-8') as f:
                        f.write("ü§ñ Zafiyet Bulucu Pro - LLM Analiz Raporu\n")
                        f.write("=" * 60 + "\n")
                        f.write(f"üìÖ Tarih: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\n")
                        f.write(f"üîç IP Adresi: {self.ip_entry.get().strip()}\n")
                        f.write(f"üìã Analiz Edilen CVE Sayƒ±sƒ±: {len(selected_cves)}\n")
                        f.write("=" * 60 + "\n\n")
                        f.write(llm_text_content)
                        f.write("\n\n‚úÖ LLM Analizi tamamlandƒ±!")
                    
                    messagebox.showinfo("‚úÖ Ba≈üarƒ±lƒ±", f"LLM analiz sonu√ßlarƒ± kaydedildi:\n{file_path}")
                
            except Exception as e:
                messagebox.showerror("‚ùå Hata", f"Dosya kaydedilirken hata olu≈ütu:\n{str(e)}")
    
    def create_llm_pdf_report(self, file_path, llm_text_content, selected_cves):
        """LLM analiz sonu√ßlarƒ± i√ßin PDF raporu olu≈ütur"""
        doc = SimpleDocTemplate(file_path, pagesize=A4)
        story = []
        
        # T√ºrk√ße karakter desteƒüi i√ßin font ayarlarƒ±
        try:
            # Helvetica kullan (en g√ºvenilir)
            default_font = 'Helvetica'
        except:
            # Fallback
            default_font = 'Helvetica'
        
        # Stil tanƒ±mlamalarƒ±
        styles = getSampleStyleSheet()
        
        # Ba≈ülƒ±k stili
        title_style = ParagraphStyle(
            'CustomTitle',
            parent=styles['Heading1'],
            fontSize=24,
            spaceAfter=30,
            alignment=TA_CENTER,
            textColor=colors.darkblue,
            fontName=default_font
        )
        
        # Alt ba≈ülƒ±k stili
        subtitle_style = ParagraphStyle(
            'CustomSubtitle',
            parent=styles['Heading2'],
            fontSize=16,
            spaceAfter=20,
            textColor=colors.darkred,
            fontName=default_font
        )
        
        # Normal metin stili
        normal_style = ParagraphStyle(
            'CustomNormal',
            parent=styles['Normal'],
            fontSize=11,
            spaceAfter=12,
            alignment=TA_JUSTIFY,
            fontName=default_font
        )
        
        # Ba≈ülƒ±k
        story.append(Paragraph(sanitize_for_pdf("Zafiyet Bulucu Pro - LLM Analiz Raporu"), title_style))
        story.append(Spacer(1, 20))
        
        # Rapor bilgileri tablosu
        report_data = [
            ['Rapor Bilgileri', ''],
            ['Tarih', sanitize_for_pdf(datetime.now().strftime('%d/%m/%Y %H:%M:%S'))],
            ['IP Adresi', sanitize_for_pdf(self.ip_entry.get().strip())],
            ['Analiz Edilen CVE Sayisi', sanitize_for_pdf(str(len(selected_cves)))],
            ['Rapor Turu', sanitize_for_pdf('LLM Cozum Onerisi Analizi')]
        ]
        
        report_table = Table(report_data, colWidths=[2*inch, 4*inch])
        report_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.darkblue),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), default_font),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTNAME', (0, 1), (-1, -1), default_font)
        ]))
        
        story.append(report_table)
        story.append(Spacer(1, 30))
        
        # LLM analiz sonu√ßlarƒ±
        story.append(Paragraph(sanitize_for_pdf("LLM Cozum Onerileri"), subtitle_style))
        story.append(Spacer(1, 15))
        
        # LLM metnini paragraflara b√∂l
        lines = llm_text_content.split('\n')
        current_paragraph = ""
        
        for line in lines:
            line = sanitize_for_pdf(line.strip())
            if line:
                if line.lower().startswith('cve id:') or line.lower().startswith('aciklama:') or 'LLM' in line:
                    if current_paragraph:
                        story.append(Paragraph(current_paragraph, normal_style))
                        current_paragraph = ""
                    story.append(Paragraph(line, normal_style))
                elif line.startswith('='):
                    if current_paragraph:
                        story.append(Paragraph(current_paragraph, normal_style))
                        current_paragraph = ""
                    story.append(Spacer(1, 10))
                else:
                    current_paragraph += line + " "
        
        if current_paragraph:
            story.append(Paragraph(current_paragraph, normal_style))
        
        story.append(Spacer(1, 30))
        story.append(Paragraph(sanitize_for_pdf("LLM Analizi tamamlandi!"), normal_style))
        
        # PDF olu≈ütur
        doc.build(story)
    
    def save_analysis_result(self):
        """Analiz sonucunu dosyaya kaydet"""
        if not self.current_analysis_result:
            messagebox.showwarning("‚ö†Ô∏è Uyarƒ±", "Kaydedilecek analiz sonucu bulunamadƒ±.\n\n√ñnce 'üîç Servisleri Bul & CVE Analizi' butonuna tƒ±klayarak analiz yapƒ±n veya LLM analizi sonu√ßlarƒ±nƒ± kaydedin.")
            return
            
        # Dosya formatƒ± se√ßimi
        file_types = [
            ("PDF Dosyasƒ±", "*.pdf"),
            ("Metin Dosyasƒ±", "*.txt"),
            ("T√ºm Dosyalar", "*.*")
        ]
        
        # Dosya kaydetme dialogu
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        default_filename = f"zafiyet_analizi_{timestamp}"
        
        file_path = filedialog.asksaveasfilename(
            title="Analiz Sonucunu Kaydet",
            defaultextension=".pdf",
            filetypes=file_types,
            initialfile=default_filename
        )
        
        if file_path:
            try:
                file_extension = os.path.splitext(file_path)[1].lower()
                
                if file_extension == '.pdf' and PDF_AVAILABLE:
                    self.create_analysis_pdf_report(file_path)
                    messagebox.showinfo("‚úÖ Ba≈üarƒ±lƒ±", f"Analiz sonucu PDF olarak kaydedildi:\n{file_path}")
                else:
                    # TXT dosyasƒ± olarak kaydet
                    if file_extension != '.txt':
                        file_path = file_path + '.txt'
                    
                    with open(file_path, 'w', encoding='utf-8') as f:
                        f.write("üîç Zafiyet Bulucu Pro - Analiz Raporu\n")
                        f.write("=" * 60 + "\n")
                        f.write(f"üìÖ Tarih: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\n")
                        f.write(f"üîç IP Adresi: {self.ip_entry.get().strip()}\n")
                        f.write("=" * 60 + "\n\n")
                        f.write(self.current_analysis_result)
                        f.write("\n\n‚úÖ Analiz tamamlandƒ±!")
                    
                    messagebox.showinfo("‚úÖ Ba≈üarƒ±lƒ±", f"Analiz sonucu kaydedildi:\n{file_path}")
                
            except Exception as e:
                messagebox.showerror("‚ùå Hata", f"Dosya kaydedilirken hata olu≈ütu:\n{str(e)}")
    
    def create_analysis_pdf_report(self, file_path):
        """Ana analiz sonu√ßlarƒ± i√ßin PDF raporu olu≈ütur"""
        doc = SimpleDocTemplate(file_path, pagesize=A4)
        story = []
        
        # T√ºrk√ße karakter desteƒüi i√ßin font ayarlarƒ±
        try:
            # Helvetica kullan (en g√ºvenilir)
            default_font = 'Helvetica'
        except:
            # Fallback
            default_font = 'Helvetica'
        
        # Stil tanƒ±mlamalarƒ±
        styles = getSampleStyleSheet()
        
        # Ba≈ülƒ±k stili
        title_style = ParagraphStyle(
            'CustomTitle',
            parent=styles['Heading1'],
            fontSize=24,
            spaceAfter=30,
            alignment=TA_CENTER,
            textColor=colors.darkblue,
            fontName=default_font
        )
        
        # Alt ba≈ülƒ±k stili
        subtitle_style = ParagraphStyle(
            'CustomSubtitle',
            parent=styles['Heading2'],
            fontSize=16,
            spaceAfter=20,
            textColor=colors.darkred,
            fontName=default_font
        )
        
        # Normal metin stili
        normal_style = ParagraphStyle(
            'CustomNormal',
            parent=styles['Normal'],
            fontSize=11,
            spaceAfter=12,
            alignment=TA_JUSTIFY,
            fontName=default_font
        )
        
        # Ba≈ülƒ±k
        story.append(Paragraph(sanitize_for_pdf("Zafiyet Bulucu Pro - Analiz Raporu"), title_style))
        story.append(Spacer(1, 20))
        
        # Rapor bilgileri tablosu
        total_services = len(self.found_services) if hasattr(self, 'found_services') else 0
        analyzed_services = len(self.cve_results) if hasattr(self, 'found_services') else 0
        skipped_services = total_services - analyzed_services
        total_cves = sum(len(cves) for cves in self.cve_results.values()) if hasattr(self, 'cve_results') else 0
        
        report_data = [
            ['Rapor Bilgileri', ''],
            ['Tarih', sanitize_for_pdf(datetime.now().strftime('%d/%m/%Y %H:%M:%S'))],
            ['IP Adresi', sanitize_for_pdf(self.ip_entry.get().strip())],
            ['Toplam Servis Sayisi', sanitize_for_pdf(str(total_services))],
            ['Analiz Edilen Servis', sanitize_for_pdf(str(analyzed_services))],
            ['Atlanan Servis (Surum Yok)', sanitize_for_pdf(str(skipped_services))],
            ['Bulunan CVE Sayisi', sanitize_for_pdf(str(total_cves))],
            ['Rapor Turu', sanitize_for_pdf('Genel Zafiyet Analizi')]
        ]
        
        report_table = Table(report_data, colWidths=[2*inch, 4*inch])
        report_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.darkblue),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), default_font),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTNAME', (0, 1), (-1, -1), default_font)
        ]))
        
        story.append(report_table)
        story.append(Spacer(1, 30))
        
        # Analiz sonu√ßlarƒ±
        story.append(Paragraph(sanitize_for_pdf("Analiz Sonuclari"), subtitle_style))
        story.append(Spacer(1, 15))
        
        # Servis detaylarƒ± tablosu
        if hasattr(self, 'found_services') and self.found_services:
            story.append(Paragraph(sanitize_for_pdf("Tespit Edilen Servisler"), subtitle_style))
            story.append(Spacer(1, 10))
            
            service_data = [[sanitize_for_pdf('Port'), sanitize_for_pdf('Urun'), sanitize_for_pdf('Surum'), sanitize_for_pdf('Durum')]]
            for service in self.found_services:
                port = sanitize_for_pdf(str(service.get('port', 'N/A')))
                urun = sanitize_for_pdf(service.get('urun', 'N/A'))
                surum = sanitize_for_pdf(service.get('surum', 'Surum bilgisi yok'))
                
                # S√ºr√ºm bilgisi varsa analiz edildi olarak i≈üaretle
                if surum and surum != 'Surum bilgisi yok':
                    status = sanitize_for_pdf("Analiz edildi")
                else:
                    status = sanitize_for_pdf("Surum yok - atlandi")
                
                service_data.append([port, urun, surum, status])
            
            service_table = Table(service_data, colWidths=[0.8*inch, 2*inch, 1.5*inch, 1.5*inch])
            service_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.darkgreen),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), default_font),
                ('FONTSIZE', (0, 0), (-1, 0), 10),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 8),
                ('BACKGROUND', (0, 1), (-1, -1), colors.lightgrey),
                ('GRID', (0, 0), (-1, -1), 1, colors.black),
                ('FONTSIZE', (0, 1), (-1, -1), 9),
                ('FONTNAME', (0, 1), (-1, -1), default_font)
            ]))
            
            story.append(service_table)
            story.append(Spacer(1, 20))
        
        # CVE detaylarƒ±
        if hasattr(self, 'cve_results') and self.cve_results:
            story.append(Paragraph(sanitize_for_pdf("Bulunan CVE'ler"), subtitle_style))
            story.append(Spacer(1, 10))
            
            for service_name, cves in self.cve_results.items():
                if cves:
                    story.append(Paragraph(sanitize_for_pdf(f"Servis: {service_name}"), normal_style))
                    story.append(Spacer(1, 5))
                    
                    for cve in cves[:3]:  # En fazla 3 CVE g√∂ster
                        cve_text = sanitize_for_pdf(f"CVE: {cve.get('cve_id', 'N/A')}")
                        if cve.get('version_match'):
                            cve_text += sanitize_for_pdf(" - Surum eslesmesi")
                        else:
                            cve_text += sanitize_for_pdf(" - Surum belirsiz")
                        
                        story.append(Paragraph(cve_text, normal_style))
                        story.append(Paragraph(sanitize_for_pdf(f"Aciklama: {cve.get('aciklama', '')[:100]}..."), normal_style))
                        story.append(Spacer(1, 5))
                    
                    if len(cves) > 3:
                        story.append(Paragraph(sanitize_for_pdf(f"... ve {len(cves) - 3} CVE daha"), normal_style))
                    
                    story.append(Spacer(1, 10))
        
        # Analiz metnini paragraflara b√∂l
        lines = self.current_analysis_result.split('\n')
        current_paragraph = ""
        
        for line in lines:
            line = line.strip()
            if line:
                if line.startswith('üîç') or line.startswith('üì°') or line.startswith('üéØ') or line.startswith('üìã'):
                    if current_paragraph:
                        story.append(Paragraph(current_paragraph, normal_style))
                        current_paragraph = ""
                    story.append(Paragraph(line, normal_style))
                elif line.startswith('='):
                    if current_paragraph:
                        story.append(Paragraph(current_paragraph, normal_style))
                        current_paragraph = ""
                    story.append(Spacer(1, 10))
                else:
                    current_paragraph += line + " "
        
        if current_paragraph:
            story.append(Paragraph(sanitize_for_pdf(current_paragraph), normal_style))
        
        story.append(Spacer(1, 30))
        story.append(Paragraph(sanitize_for_pdf("Analiz tamamlandi!"), normal_style))
        
        # PDF olu≈ütur
        doc.build(story)
    
    def show_nmap_scan_card(self):
        """Hƒ±zlƒ± Nmap tarama kartƒ±nƒ± g√∂ster"""
        for widget in self.card_frame.winfo_children():
            widget.destroy()
            
        # Ana kart
        card = tk.Frame(
            self.card_frame,
            bg=self.colors['bg_card'],
            relief='flat',
            bd=0
        )
        card.pack(fill='both', expand=True, padx=20, pady=20)
        
        # √úst bar
        top_bar = tk.Frame(card, bg=self.colors['bg_card'])
        top_bar.pack(fill='x', padx=20, pady=20)
        
        # Geri butonu
        back_btn = self.create_rounded_button(
            top_bar, "‚Üê Geri", self.show_main_menu_card, 'warning', 'small'
        )
        back_btn.pack(side='left')
        
        # Ba≈ülƒ±k
        title = tk.Label(
            top_bar,
            text="‚ö° Hƒ±zlƒ± Nmap Tarama",
            font=("Segoe UI", 20, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        title.pack(side='right')
        
        # Sol panel
        left_panel = tk.Frame(card, bg=self.colors['bg_card'])
        left_panel.pack(side='left', fill='y', padx=(40, 20), pady=30)
        
        # IP giri≈üi
        input_label = tk.Label(
            left_panel,
            text="IP Adresi:",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        input_label.pack(anchor='w', pady=(0, 10))
        
        # Input container
        input_container = tk.Frame(left_panel, bg=self.colors['bg_input'], relief='flat', bd=0)
        input_container.pack(fill='x', pady=(0, 20))
        
        self.nmap_ip_entry = tk.Entry(
            input_container,
            font=("Consolas", 14),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            relief='flat',
            bd=0,
            insertbackground=self.colors['text_light']
        )
        self.nmap_ip_entry.pack(fill='x', padx=15, pady=15)
        
        # Port aralƒ±ƒüƒ± se√ßimi
        port_label = tk.Label(
            left_panel,
            text="Port Aralƒ±ƒüƒ±:",
            font=("Segoe UI", 12, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        port_label.pack(anchor='w', pady=(20, 10))
        
        # Port aralƒ±ƒüƒ± combobox
        port_frame = tk.Frame(left_panel, bg=self.colors['bg_input'], relief='flat', bd=0)
        port_frame.pack(fill='x', pady=(0, 20))
        
        self.port_range_var = tk.StringVar(value="1-1000")
        port_combo = ttk.Combobox(
            port_frame,
            textvariable=self.port_range_var,
            values=["1-100", "1-1000", "1-10000", "1-65535"],
            font=("Consolas", 12),
            state="readonly"
        )
        port_combo.pack(fill='x', padx=15, pady=15)
        
        # Buton container
        button_container = tk.Frame(left_panel, bg=self.colors['bg_card'])
        button_container.pack(fill='x', pady=20)
        
        # Hƒ±zlƒ± port tarama butonu
        quick_btn = self.create_rounded_button(
            button_container, "‚ö° Hƒ±zlƒ± Port Tarama", self.quick_port_scan, 'success'
        )
        quick_btn.pack(fill='x', pady=(0, 10))
        
        # Servis tarama butonu
        service_btn = self.create_rounded_button(
            button_container, "üîç Servis & S√ºr√ºm Tarama", self.service_scan, 'primary'
        )
        service_btn.pack(fill='x', pady=(0, 10))
        
        # Tam analiz butonu
        full_btn = self.create_rounded_button(
            button_container, "üéØ Tam Analiz (Port + Servis + CVE)", self.full_nmap_analysis, 'accent'
        )
        full_btn.pack(fill='x')
        
        # Saƒü panel
        right_panel = tk.Frame(card, bg=self.colors['bg_card'])
        right_panel.pack(side='right', fill='both', expand=True, padx=(20, 40), pady=30)
        
        result_label = tk.Label(
            right_panel,
            text=" Tarama Sonu√ßlarƒ±:",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        result_label.pack(anchor='w', pady=(0, 10))
        
        # Sonu√ß text alanƒ±
        self.nmap_result_text = scrolledtext.ScrolledText(
            right_panel,
            height=25,
            font=("Consolas", 11),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            relief='flat',
            bd=0,
            insertbackground=self.colors['text_light'],
            selectbackground=self.colors['primary']
        )
        self.nmap_result_text.pack(fill='both', expand=True)
    
    def quick_port_scan(self):
        """Hƒ±zlƒ± port tarama"""
        ip = self.nmap_ip_entry.get().strip()
        port_range = self.port_range_var.get()
        
        if not ip:
            messagebox.showerror("Hata", "L√ºtfen bir IP adresi girin!")
            return
            
        def run_quick_scan():
            self.nmap_result_text.delete(1.0, tk.END)
            self.nmap_result_text.insert(tk.END, f"‚ö° {ip} i√ßin hƒ±zlƒ± port taramasƒ± ba≈ülatƒ±lƒ±yor...\n")
            self.nmap_result_text.insert(tk.END, f"üì° Port aralƒ±ƒüƒ±: {port_range}\n")
            self.nmap_result_text.insert(tk.END, "=" * 80 + "\n\n")
            self.root.update()
            
            try:
                acik_portlar = nmap_hizli_port_tarama(ip, port_range)
                
                if acik_portlar:
                    self.nmap_result_text.insert(tk.END, f"‚úÖ Tarama tamamlandƒ±! {len(acik_portlar)} a√ßƒ±k port bulundu:\n\n")
                    for port in sorted(acik_portlar):
                        self.nmap_result_text.insert(tk.END, f"üîì Port {port} a√ßƒ±k\n")
                else:
                    self.nmap_result_text.insert(tk.END, "‚ùå A√ßƒ±k port bulunamadƒ±.\n")
                    
            except Exception as e:
                self.nmap_result_text.insert(tk.END, f"\n‚ùå Hata: {str(e)}\n")
                
        threading.Thread(target=run_quick_scan, daemon=True).start()
    
    def service_scan(self):
        """Servis ve s√ºr√ºm tarama"""
        ip = self.nmap_ip_entry.get().strip()
        port_range = self.port_range_var.get()
        
        if not ip:
            messagebox.showerror("Hata", "L√ºtfen bir IP adresi girin!")
            return
            
        def run_service_scan():
            self.nmap_result_text.delete(1.0, tk.END)
            self.nmap_result_text.insert(tk.END, f"üîç {ip} i√ßin servis taramasƒ± ba≈ülatƒ±lƒ±yor...\n")
            self.nmap_result_text.insert(tk.END, f"üì° Port aralƒ±ƒüƒ±: {port_range}\n")
            self.nmap_result_text.insert(tk.END, "=" * 80 + "\n\n")
            self.root.update()
            
            try:
                servisler = nmap_ile_servisleri_bul(ip, port_range)
                
                if servisler:
                    self.nmap_result_text.insert(tk.END, f"‚úÖ Tarama tamamlandƒ±! {len(servisler)} servis bulundu:\n\n")
                    
                    for servis in servisler:
                        port = servis['port']
                        urun = servis['urun']
                        surum = servis['surum']
                        
                        self.nmap_result_text.insert(tk.END, f"üîç Port {port}:\n")
                        self.nmap_result_text.insert(tk.END, f"   üìã √úr√ºn: {urun}\n")
                        self.nmap_result_text.insert(tk.END, f"   üì¶ S√ºr√ºm: {surum or 'Bilinmiyor'}\n")
                        self.nmap_result_text.insert(tk.END, "-" * 40 + "\n")
                else:
                    self.nmap_result_text.insert(tk.END, "‚ùå Servis bulunamadƒ±.\n")
                    
            except Exception as e:
                self.nmap_result_text.insert(tk.END, f"\n‚ùå Hata: {str(e)}\n")
                
        threading.Thread(target=run_service_scan, daemon=True).start()
    
    def full_nmap_analysis(self):
        """Tam analiz (Port + Servis + CVE)"""
        ip = self.nmap_ip_entry.get().strip()
        port_range = self.port_range_var.get()
        
        if not ip:
            messagebox.showerror("Hata", "L√ºtfen bir IP adresi girin!")
            return
            
        def run_full_analysis():
            self.nmap_result_text.delete(1.0, tk.END)
            self.nmap_result_text.insert(tk.END, f"üéØ {ip} i√ßin tam analiz ba≈ülatƒ±lƒ±yor...\n")
            self.nmap_result_text.insert(tk.END, f"üì° Port aralƒ±ƒüƒ±: {port_range}\n")
            self.nmap_result_text.insert(tk.END, "=" * 80 + "\n\n")
            self.root.update()
            
            try:
                # 1. Servis tarama
                self.nmap_result_text.insert(tk.END, "üîç 1. Adƒ±m: Servis taramasƒ±...\n")
                servisler = nmap_ile_servisleri_bul(ip, port_range)
                
                if not servisler:
                    self.nmap_result_text.insert(tk.END, "‚ùå Servis bulunamadƒ±. Analiz sonlandƒ±rƒ±lƒ±yor.\n")
                    return
                
                self.nmap_result_text.insert(tk.END, f"‚úÖ {len(servisler)} servis bulundu!\n\n")
                
                # 2. CVE analizi
                self.nmap_result_text.insert(tk.END, "üîç 2. Adƒ±m: CVE analizi...\n")
                total_cves = 0
                cve_results = {}
                
                for i, servis in enumerate(servisler, 1):
                    urun = servis['urun']
                    surum = servis['surum']
                    port = servis['port']
                    
                    self.nmap_result_text.insert(tk.END, f"üìã [{i}/{len(servisler)}] {urun} (Port: {port})\n")
                    
                    if not surum:
                        self.nmap_result_text.insert(tk.END, f"   ‚ö†Ô∏è S√ºr√ºm bilgisi yok - CVE analizi atlanƒ±yor.\n\n")
                        continue
                    
                    self.nmap_result_text.insert(tk.END, f"   üì¶ S√ºr√ºm: {surum}\n")
                    self.nmap_result_text.insert(tk.END, f"   üîç CVE aranƒ±yor...\n")
                    
                    cve_listesi = mitre_cve_ara(urun, surum)
                    
                    if cve_listesi:
                        self.nmap_result_text.insert(tk.END, f"   ‚úÖ {len(cve_listesi)} CVE bulundu!\n")
                        total_cves += len(cve_listesi)
                        cve_results[f"{urun}_{surum}"] = cve_listesi
                        
                        for j, cve in enumerate(cve_listesi[:3], 1):
                            self.nmap_result_text.insert(tk.END, f"      {j}. {cve['cve_id']}: {cve['aciklama'][:80]}...\n")
                        
                        if len(cve_listesi) > 3:
                            self.nmap_result_text.insert(tk.END, f"      ... ve {len(cve_listesi) - 3} CVE daha\n")
                    else:
                        self.nmap_result_text.insert(tk.END, f"   ‚ùå CVE bulunamadƒ±.\n")
                    
                    self.nmap_result_text.insert(tk.END, "\n")
                    
                    if i < len(servisler):
                        self.root.update()
                        import time
                        time.sleep(0.2)
                
                # 3. √ñzet
                self.nmap_result_text.insert(tk.END, f"üéØ Tam analiz tamamlandƒ±!\n")
                self.nmap_result_text.insert(tk.END, f"üìä √ñzet:\n")
                self.nmap_result_text.insert(tk.END, f"   ‚Ä¢ Toplam Servis: {len(servisler)}\n")
                self.nmap_result_text.insert(tk.END, f"   ‚Ä¢ Analiz Edilen: {len(cve_results)}\n")
                self.nmap_result_text.insert(tk.END, f"   ‚Ä¢ Bulunan CVE: {total_cves}\n")
                
                # Sonu√ßlarƒ± sakla
                self.found_services = servisler
                self.cve_results = cve_results
                self.current_analysis_result = f"üîç IP Adresi: {ip}\n"
                self.current_analysis_result += f"üì° Toplam Servis: {len(servisler)}\n"
                self.current_analysis_result += f"üéØ Bulunan CVE: {total_cves}\n"
                self.current_analysis_result += "=" * 60 + "\n\n"
                
                for service_key, cve_list in cve_results.items():
                    self.current_analysis_result += f"üìã Servis: {service_key.replace('_', ' ')}\n"
                    for cve in cve_list:
                        self.current_analysis_result += f"  üîç {cve['cve_id']}: {cve['aciklama']}\n"
                    self.current_analysis_result += "\n"
                    
            except Exception as e:
                self.nmap_result_text.insert(tk.END, f"\n‚ùå Hata: {str(e)}\n")
                
        threading.Thread(target=run_full_analysis, daemon=True).start()
        
    def show_port_list_card(self):
       
        for widget in self.card_frame.winfo_children():
            widget.destroy()
            
     
        card = tk.Frame(
            self.card_frame,
            bg=self.colors['bg_card'],
            relief='flat',
            bd=0
        )
        card.pack(fill='both', expand=True, padx=20, pady=20)
        

        top_bar = tk.Frame(card, bg=self.colors['bg_card'])
        top_bar.pack(fill='x', padx=20, pady=20)
        

        back_btn = self.create_rounded_button(
            top_bar, "‚Üê Geri", self.show_main_menu_card, 'warning', 'small'
        )
        back_btn.pack(side='left')
        
        title = tk.Label(
            top_bar,
            text=" A√ßƒ±k Port Taramasƒ±",
            font=("Segoe UI", 20, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        title.pack(side='right')
        
  
        left_panel = tk.Frame(card, bg=self.colors['bg_card'])
        left_panel.pack(side='left', fill='y', padx=(40, 20), pady=30)
        
       
        ip_label = tk.Label(
            left_panel,
            text="IP Adresi:",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        ip_label.pack(anchor='w', pady=(0, 10))
        
        
        input_container = tk.Frame(left_panel, bg=self.colors['bg_input'], relief='flat', bd=0)
        input_container.pack(fill='x', pady=(0, 20))
        
        self.port_ip_entry = tk.Entry(
            input_container,
            font=("Consolas", 14),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            relief='flat',
            bd=0,
            insertbackground=self.colors['text_light']
        )
        self.port_ip_entry.pack(fill='x', padx=15, pady=15)
        
        
        list_btn = self.create_rounded_button(
            left_panel, " Portlarƒ± Tara", self.list_ports, 'accent'
        )
        list_btn.pack(pady=20)
        
        
        right_panel = tk.Frame(card, bg=self.colors['bg_card'])
        right_panel.pack(side='right', fill='both', expand=True, padx=(20, 40), pady=30)
        
        result_label = tk.Label(
            right_panel,
            text=" Port Tarama Sonu√ßlarƒ±:",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        result_label.pack(anchor='w', pady=(0, 10))
        
        
        self.port_result_text = scrolledtext.ScrolledText(
            right_panel,
            height=25,
            font=("Consolas", 11),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            relief='flat',
            bd=0,
            insertbackground=self.colors['text_light'],
            selectbackground=self.colors['primary']
        )
        self.port_result_text.pack(fill='both', expand=True)
        
    def list_ports(self):
        ip = self.port_ip_entry.get().strip()
        if not ip:
            messagebox.showerror("Hata", "L√ºtfen bir IP adresi girin!")
            return
            
        def run_port_scan():
            self.port_result_text.delete(1.0, tk.END)
            self.port_result_text.insert(tk.END, f" {ip} portlarƒ± taranƒ±yor...\n")
            self.port_result_text.insert(tk.END, "=" * 80 + "\n\n")
            self.root.update()
            
            try:
                
                with self.output_capture.capture_output():
                    shodan_ip_acik_portlari_goster(ip)
                
                
                self.port_result_text.insert(tk.END, self.output_capture.output)
                self.port_result_text.insert(tk.END, "\n Port taramasƒ± tamamlandƒ±!\n")
            except Exception as e:
                self.port_result_text.insert(tk.END, f"\n Hata: {str(e)}\n")
                
        threading.Thread(target=run_port_scan, daemon=True).start()
        
    def show_general_search_card(self):
        
        for widget in self.card_frame.winfo_children():
            widget.destroy()
            
        
        card = tk.Frame(
            self.card_frame,
            bg=self.colors['bg_card'],
            relief='flat',
            bd=0
        )
        card.pack(fill='both', expand=True, padx=20, pady=20)
        
       
        top_bar = tk.Frame(card, bg=self.colors['bg_card'])
        top_bar.pack(fill='x', padx=20, pady=20)
        
        
        back_btn = self.create_rounded_button(
            top_bar, "‚Üê Geri", self.show_main_menu_card, 'warning', 'small'
        )
        back_btn.pack(side='left')
        
        
        title = tk.Label(
            top_bar,
            text=" Shodan Arama",
            font=("Segoe UI", 20, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        title.pack(side='right')
        
        
        left_panel = tk.Frame(card, bg=self.colors['bg_card'])
        left_panel.pack(side='left', fill='y', padx=(40, 20), pady=30)
        
        
        search_label = tk.Label(
            left_panel,
            text="Arama Terimi:",
            font=("Segoe UI", 12, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        search_label.pack(anchor='w', pady=(0, 10))
        
        
        input_container = tk.Frame(left_panel, bg=self.colors['bg_input'], relief='flat', bd=0)
        input_container.pack(fill='x', pady=(0, 20))
        
        self.search_entry = tk.Entry(
            input_container,
            font=("Consolas", 14),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            relief='flat',
            bd=0,
            insertbackground=self.colors['text_light']
        )
        self.search_entry.pack(fill='x', padx=15, pady=15)
        
       
        search_btn = self.create_rounded_button(
            left_panel, " Ara", self.general_search, 'danger'
        )
        search_btn.pack(pady=20)
        
        
        right_panel = tk.Frame(card, bg=self.colors['bg_card'])
        right_panel.pack(side='right', fill='both', expand=True, padx=(20, 40), pady=30)
        
        result_label = tk.Label(
            right_panel,
            text=" Arama Sonu√ßlarƒ±:",
            font=("Segoe UI", 14, "bold"),
            fg=self.colors['text_light'],
            bg=self.colors['bg_card']
        )
        result_label.pack(anchor='w', pady=(0, 10))
        
        
        self.search_result_text = scrolledtext.ScrolledText(
            right_panel,
            height=25,
            font=("Consolas", 11),
            bg=self.colors['bg_input'],
            fg=self.colors['text_light'],
            relief='flat',
            bd=0,
            insertbackground=self.colors['text_light'],
            selectbackground=self.colors['primary']
        )
        self.search_result_text.pack(fill='both', expand=True)
        
    def general_search(self):
        search_term = self.search_entry.get().strip()
        if not search_term:
            messagebox.showerror("Hata", "L√ºtfen bir arama terimi girin!")
            return
            
        def run_search():
            self.search_result_text.delete(1.0, tk.END)
            self.search_result_text.insert(tk.END, f" '{search_term}' aranƒ±yor...\n")
            self.search_result_text.insert(tk.END, "=" * 80 + "\n\n")
            self.root.update()
            
            try:
                
                with self.output_capture.capture_output():
                    shodan_genel_arama(search_term)
                
                
                self.search_result_text.insert(tk.END, self.output_capture.output)
                self.search_result_text.insert(tk.END, "\n Arama tamamlandƒ±!\n")
            except Exception as e:
                self.search_result_text.insert(tk.END, f"\n Hata: {str(e)}\n")
                
        threading.Thread(target=run_search, daemon=True).start()

def main():
    load_dotenv()
    root = tk.Tk()
    app = ModernUI(root)
    root.mainloop()

if __name__ == "__main__":
    main()